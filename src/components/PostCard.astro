---  
import { Image } from "astro:assets";
import dayjs from "@utils/dayjs";
import { DATE_FORMAT, t, umamiConfig } from "@config";
import type { PostData } from "@interfaces/data";
import Heading from "./widgets/Heading.astro";
import PostStats from "./widgets/PostStats.astro";
import PostFilter from "./widgets/PostFilter.astro";
import Card from "./temple/Card.astro";
import { Icon } from "astro-icon/components";  
  
const {  
  title,  
  image,  
  pubDate,  
  description,  
  badge,  
  categories = [],  
  tags = [],  
  word = "0",  
  time = "0",  
  url = decodeURIComponent(Astro.url.toString()),  
} = Astro.props as PostData;  
  
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";
const slug = url ? url.split('/').filter(Boolean).pop() : undefined;
---  
  
<Card class="overflow-hidden">  <!-- Mobile Layout (Vertical) -->  <div class="flex flex-col w-full lg:hidden">    <!-- Image Section -->    {      image && (        <a href={url} class="relative w-full aspect-video overflow-hidden group">          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/60 z-10 transition-all duration-300 flex items-center justify-center">            <Icon              name="lucide:arrow-right"              class="w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:translate-x-2"            />          </div>          <Image            src={image}            alt={title}            width={800}            height={400}            format="webp"            loading="lazy"            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"          />        </a>      )    }    <!-- Content Section -->    <div class="p-4 overflow-hidden flex flex-col">      <div class="mb-3">        <Heading url={url} title={title}>{title}</Heading>      </div>            <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-sm text-base-content/70 mb-3 opacity-75">        {          pubDate && (            <span class="flex items-center gap-1">              <Icon name="lucide:calendar" class="h-4 w-4 flex-shrink-0" />              <span class="truncate">{displayDate}</span>            </span>          )        }        <div class="flex items-center gap-1">          <Icon name="lucide:book-open" class="h-4 w-4 flex-shrink-0" />          <span class="truncate">{word} {t("label.wordCount")} · {time} {t("label.readTime")}</span>        </div>        {          badge && (            <span class="flex items-center gap-1">              <Icon name="lucide:bookmark" class="h-4 w-4 flex-shrink-0" />              <span class="truncate">{badge}</span>            </span>          )        }        <PostStats url={url} layout="mobile" />      </div>      <p class="text-sm text-base-content/70 mb-4">{description}</p>            <!-- Categories and Tags Section -->      <PostFilter categories={categories} tags={tags} />    </div>  </div>  <!-- Desktop Layout (Horizontal) -->  <div class="hidden lg:flex flex-row min-h-24 h-auto">    <!-- Content Section -->    <div class="flex-1 p-6 overflow-hidden order-1 flex flex-col justify-between">      <div class="overflow-hidden">        <div class="mb-1">          <Heading url={url} title={title}>{title}</Heading>        </div>                <div class="grid grid-cols-[auto_auto] gap-x-4 gap-y-1 text-sm text-base-content/70 mb-4 opacity-75">          {            pubDate && (              <span class="flex items-center gap-1">                <Icon name="lucide:calendar" class="h-4 w-4 flex-shrink-0" />                <span class="truncate">{displayDate}</span>              </span>            )          }          <div class="flex items-center gap-1">            <Icon name="lucide:book-open" class="h-4 w-4 flex-shrink-0" />            <span class="truncate">{word} {t("label.wordCount")} · {time} {t("label.readTime")}</span>          </div>          {            badge && (              <span class="flex items-center gap-1">                <Icon name="lucide:bookmark" class="h-4 w-4 flex-shrink-0" />                <span class="truncate">{badge}</span>              </span>            )          }          <PostStats url={url} layout="desktop" />        </div>        <p class="text-sm text-base-content/70 mb-4">{description}</p>      </div>      <div>        <PostFilter categories={categories} tags={tags} />      </div>    </div>    <!-- Image Section -->    {      image && (        <a href={url} class="relative w-2/5 lg:w-2/5 lg:aspect-auto overflow-hidden order-2 group">          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/60 z-10 transition-all duration-300 flex items-center justify-center">            <Icon              name="lucide:arrow-right"              class="w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:translate-x-2"            />          </div>          <Image            src={image}            alt={title}            width={800}            height={400}            format="webp"            loading="lazy"            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"          />        </a>      )    }  </div>  {slug && umamiConfig.enable && (
    <script define:vars={{ slug, umamiConfig }} is:inline>
      // 全局共享数据缓存
      window.postStatsCache = window.postStatsCache || {};
      
      // 获取文章浏览量统计，支持 websiteId 或 shareId
      async function fetchPostViews() {
        if (!umamiConfig.enable) {
          return;
        }
        
        // 如果已经有缓存数据，直接使用
        if (window.postStatsCache[slug]) {
          updateAllStats(window.postStatsCache[slug]);
          return;
        }
        
        const checkInterval = setInterval(async () => {
          if (typeof window.fetchUmamiStats === 'function') {
            clearInterval(checkInterval);
            try {
              // RyuChan assumes blog posts are at /blog/slug
              // Adjust this path if your URL structure is different
              const queryPath = `/blog/${slug}`;
              
              const statsData = await window.fetchUmamiStats(umamiConfig.baseUrl, umamiConfig.shareId, {
                timezone: umamiConfig.timezone,
                path: queryPath
              });
              
              const pageViews = (typeof statsData.pageviews === 'object' ? statsData.pageviews.value : statsData.pageviews) || 0;
              const visits = (typeof statsData.visitors === 'object' ? statsData.visitors.value : statsData.visitors) || 0;
              
              // 缓存数据
              window.postStatsCache[slug] = { pageViews, visits };
              
              // 更新所有布局的统计数据
              updateAllStats({ pageViews, visits });
            } catch (error) {
              console.error('Error fetching page views for', slug, ':', error);
              updateAllStats({ pageViews: 0, visits: 0 });
            }
          }
        }, 100);
        
        // Stop checking after 10 seconds
        setTimeout(() => clearInterval(checkInterval), 10000);
      }
      
      // 更新所有布局的统计数据
      function updateAllStats(stats) {
        const { pageViews, visits } = stats;
        
        // 更新移动端布局
        const mobileViewsElement = document.getElementById(`page-views-${slug}-mobile`);
        const mobileVisitorsElement = document.getElementById(`page-visitors-${slug}-mobile`);
        
        // 更新桌面端布局
        const desktopViewsElement = document.getElementById(`page-views-${slug}-desktop`);
        const desktopVisitorsElement = document.getElementById(`page-visitors-${slug}-desktop`);
        
        if (mobileViewsElement) mobileViewsElement.textContent = `${pageViews} 次`;
        if (mobileVisitorsElement) mobileVisitorsElement.textContent = `${visits} 人`;
        
        if (desktopViewsElement) desktopViewsElement.textContent = `${pageViews} 次`;
        if (desktopVisitorsElement) desktopVisitorsElement.textContent = `${visits} 人`;
      }
      
      // 页面加载完成后获取统计数据
      document.addEventListener('astro:page-load', fetchPostViews);
      // Initial run for direct loads (though astro:page-load covers it usually)
      if (document.readyState === 'complete') fetchPostViews();
      else document.addEventListener('DOMContentLoaded', fetchPostViews);
    </script>
  )}
</Card>